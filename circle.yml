checkout:
    pre:
        - sudo apt-add-repository -y 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.4 main'
        - wget -q -O - http://llvm.org/apt/llvm-snapshot.gpg.key | sudo apt-key add -
        - sudo apt-get update
        - sudo apt-get install clang-3.4 clang-3.4-doc libclang-common-3.4-dev libclang-3.4-dev libclang1-3.4 libclang1-3.4-dbg libllvm3.4 libllvm3.4-dbg llvm-3.4 llvm-3.4-dev llvm-3.4-doc llvm-3.4-examples llvm-3.4-runtime cpp11-migrate-3.4 clang-format-3.4

    post:
        - cd ..; hg clone https://hg.mozilla.org/projects/nspr

        # Build with GCC
        - make nss_build_all

        # Build with Clang/ASan
        - make ZDEFS_FLAG= CC='clang-3.4 -fsanitize=address -fno-omit-frame-pointer' CCC='clang++-3.4 -fsanitize=address -fno-omit-frame-pointer' nss_build_all


test:
    override:
        # Test with GCC
        - cd tests; NSS_TESTS=ssl_gtests NSS_CYCLES=standard ./all.sh

        # Test with Clang/ASan. OBJDIR is hacky but necessary
        - cd tests; OBJDIR=Linux3.13_x86_64_clang_glibc_PTH_64_DBG.OBJ NSS_TESTS=ssl_gtests NSS_CYCLES=standard ./all.sh

machine:
    environment:
        { USE_64: 1,
          NSS_ENABLE_TLS_1_3: 1,
          NSS_BUILD_GTESTS: 1,
          HOST: 'nss-tests'
        }
    hosts:


